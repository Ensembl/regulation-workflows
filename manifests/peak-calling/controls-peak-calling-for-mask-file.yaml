apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: controls-peak-calling-for-mask-file-v1-submittable
spec:
  entrypoint: controls-peak-calling-for-mask-file

  imagePullSecrets:
    - name: ghcr-pull-token

  templates:
    - name: controls-peak-calling-for-mask-file
      parallelism: 15
      inputs:
        parameters:
          - name: peak_calling_tasks
          - name: chipmentation
          - name: overwrite-results
          - name: kubeconfig-path
      dag:
        tasks:
          - name: execute-peak-calling-task
            template: peak-calling-task
            arguments:
              parameters:
                - name: task-payload
                  value: "{{item}}"
                - name: assembly_id
                  value: "{{item.assembly_id}}"
                - name: out_basename
                  value: "{{item.out_basename}}"
                - name: out_s3_prefix
                  value: "{{item.out_s3_prefix}}"
                - name: alignment_files_total_size
                  value: "{{item.alignment_files_total_size}}"
                - name: signals
                  value: "{{item.signals}}"
                - name: chipmentation
                  value: "{{inputs.parameters.chipmentation}}"
                - name: overwrite-results
                  value: "{{inputs.parameters.overwrite-results}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"
            withParam: "{{inputs.parameters.peak_calling_tasks}}"


    - name: peak-calling-task
      parallelism: 15
      inputs:
        parameters:
          - name: task-payload
          - name: assembly_id
          - name: out_basename
          - name: out_s3_prefix
          - name: alignment_files_total_size
          - name: signals
          - name: kubeconfig-path
          - name: chipmentation
          - name: overwrite-results
          - name: force-update-task-markers
            value: "false"

      dag:
        tasks:
          - name: check-if-bed-file-already-in-s3-bucket
            templateRef:
              name: check-s3-object-exists-v1-submittable
              template: check-s3-object-exists
            arguments:
              parameters:
                - name: s3-key
                  value: "{{inputs.parameters.out_s3_prefix}}{{inputs.parameters.out_basename}}.bed"

          - name: get-peak-calling-pvc-size
            depends: check-if-bed-file-already-in-s3-bucket.Succeeded
            when: "{{tasks.check-if-bed-file-already-in-s3-bucket.outputs.parameters.s3-object-exists}} == false"
            templateRef:
              name: compute-pvc-size-v1-submittable
              template: compute-pvc-size
            arguments:
              parameters:
                - name: associated_files_size
                  value: "{{inputs.parameters.alignment_files_total_size}}"
                - name: size_factor
                  value: "4.5"

          - name: create-peak-calling-pvc
            depends: "get-peak-calling-pvc-size.Succeeded"
            templateRef:
              name: create-pvc-kubectl-v1-submittable
              template: create-pvc-kubectl
            arguments:
              parameters:
                - name: pvc-size
                  value: "{{tasks.get-peak-calling-pvc-size.outputs.parameters.pvc-size-formatted}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"

          - name: execute-sort-alignments-by-queryname
            depends: create-peak-calling-pvc
            template: sort-alignments-by-queryname
            arguments:
              parameters:
                - name: sort_alignment_params
                  value: "{{item}}"
                # PVC in which to store so_queryname bams
                - name: out-pvc-name
                  value: "{{tasks.create-peak-calling-pvc.outputs.parameters.pvc-name}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"
            withParam: "{{inputs.parameters.signals}}"

          - name: get-genrich-values-pvcs-size
            depends: execute-sort-alignments-by-queryname.Succeeded
            templateRef:
              name: compute-pvc-size-v1-submittable
              template: compute-pvc-size
            arguments:
              parameters:
                - name: associated_files_size
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.alignment_files_total_size')}}"
                - name: size_factor
                  value: "3"

          - name: create-pq-values-pvc
            depends: get-genrich-values-pvcs-size.Succeeded
            templateRef:
              name: create-pvc-kubectl-v1-submittable
              template: create-pvc-kubectl
            arguments:
              parameters:
                - name: pvc-size
                  value: "{{tasks.get-genrich-values-pvcs-size.outputs.parameters.pvc-size-formatted}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"

          - name: create-pileups-pvc
            depends: get-genrich-values-pvcs-size.Succeeded
            templateRef:
              name: create-pvc-kubectl-v1-submittable
              template: create-pvc-kubectl
            arguments:
              parameters:
                - name: pvc-size
                  value: "{{tasks.get-genrich-values-pvcs-size.outputs.parameters.pvc-size-formatted}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"

          - name: execute-genrich-controls
            depends: >-
              create-pq-values-pvc.Succeeded && create-pileups-pvc.Succeeded
            template: genrich-controls
            arguments:
              parameters:
                - name: out_bed_filename
                  value: "peaks-{{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}.bed"
                - name: out_pileups_filename
                  value: "pileups-{{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}.txt"
                - name: out_pq_values_filename
                  value: "pq-values-{{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}.txt"
                - name: out_s3_prefix
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.out_s3_prefix')}}"
                - name: chipmentation
                  value: "{{inputs.parameters.chipmentation}}"
                - name: alignments-pvc
                  value: "{{tasks.create-peak-calling-pvc.outputs.parameters.pvc-name}}"
                - name: pq-values-pvc
                  value: "{{tasks.create-pq-values-pvc.outputs.parameters.pvc-name}}"
                - name: pileups-pvc
                  value: "{{tasks.create-pileups-pvc.outputs.parameters.pvc-name}}"

          - name: delete-peak-calling-pvc
            depends: execute-genrich-controls.Succeeded
            templateRef:
              name: delete-patch-pvc-kubectl-v1-submittable
              template: delete-patch-pvc-kubectl
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{tasks.create-peak-calling-pvc.outputs.parameters.pvc-name}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"

          - name: output-files-post-processing
            depends: execute-genrich-controls.Succeeded
            template: dag-output-files-post-processing
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{item.pvc-name}}"
                - name: task-payload
                  value: "{{inputs.parameters.task-payload}}"
                - name: analysis-type-info
                  value: "{{item}}"
            withParam: >-
              [
                { "analysis_type": "genrich_pq_values",
                  "prefix": "pq-values-",
                  "suffix": ".txt",
                  "pvc-name": "{{tasks.create-pq-values-pvc.outputs.parameters.pvc-name}}"
                },
                { "analysis_type": "genrich_pileups",
                  "prefix": "pileups-",
                  "suffix": ".txt",
                  "pvc-name": "{{tasks.create-pileups-pvc.outputs.parameters.pvc-name}}" 
                }
              ]

          - name: delete-pq-values-pvc
            depends: output-files-post-processing.Succeeded
            templateRef:
              name: delete-patch-pvc-kubectl-v1-submittable
              template: delete-patch-pvc-kubectl
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{tasks.create-pq-values-pvc.outputs.parameters.pvc-name}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"

          - name: delete-pileups-pvc
            depends: output-files-post-processing.Succeeded
            templateRef:
              name: delete-patch-pvc-kubectl-v1-submittable
              template: delete-patch-pvc-kubectl
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{tasks.create-pileups-pvc.outputs.parameters.pvc-name}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"

          - name: output-bed-file-post-processing
            depends: execute-genrich-controls.Succeeded
            template: dag-bed-output-files-post-processing
            arguments:
              parameters:
                - name: task-payload
                  value: "{{inputs.parameters.task-payload}}"
                - name: analysis-type-info
                  value: "{{item}}"
            withParam: >-
              [
                { "analysis_type": "control_peaks",
                  "prefix": "peaks-",
                  "suffix": ".bed"
                }
              ]

          - name: save-genrich-logs
            depends: execute-genrich-controls.Succeeded
            templateRef:
              name: cp-s3-object-to-s3-v1-submittable
              template: cp-s3-object-to-s3
            arguments:
              parameters:
                - name: in-s3-key
                  value: "{{tasks.execute-genrich-controls.outputs.parameters.genrich-run-logs-s3-key}}"
                - name: out-s3-key
                  value: "{{=sprig.trimSuffix('.bed', tasks['get-s3-keys-and-set-of-genrich-cmds'].outputs.parameters['peaks-s3-key'])}}.log"



    - name: sort-alignments-by-queryname
      inputs:
        parameters:
          # Bam file as input
          - name: sort_alignment_params
          # PVC in which to store bedgraph
          - name: out-pvc-name
          - name: kubeconfig-path
      dag:
        tasks:
          - name: get-pvc-size
            templateRef:
              name: compute-pvc-size-v1-submittable
              template: compute-pvc-size
            arguments:
              parameters:
                - name: associated_files_size
                  value: "{{=jsonpath(inputs.parameters.sort_alignment_params, '$.file_size')}}"
                - name: size_factor
                  value: "1.5"

          - name: execute-sort-alignment-by-queryname
            depends: get-pvc-size
            templateRef:
              name: sort-alignment-by-queryname-pvc-callable-v1-submittable
              template: sort-alignment-by-queryname-pvc-callable
            arguments:
              parameters:
                - name: basename
                  value: "{{=jsonpath(inputs.parameters.sort_alignment_params, '$.basename')}}"
                - name: filename
                  value: "{{=jsonpath(inputs.parameters.sort_alignment_params, '$.filename')}}"
                - name: s3_key
                  value: "{{=jsonpath(inputs.parameters.sort_alignment_params, '$.s3_key')}}"
                - name: pvc-size
                  value: "{{tasks.get-pvc-size.outputs.parameters.pvc-size-formatted}}"
                - name: kubeconfig-path
                  value: "{{inputs.parameters.kubeconfig-path}}"
                - name: out-pvc-name
                  value: "{{inputs.parameters.out-pvc-name}}"

    - name: dag-output-files-post-processing
      parallelism: 1
      inputs:
        parameters:
          - name: pvc-name
          - name: task-payload
          - name: analysis-type-info
      dag:
        tasks:
          - name: compute-output-file-metadata
            templateRef:
              name: compute-file-metadata-pvc-callable-v1-submittable
              template: compute-file-metadata-pvc-callable
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"
                - name: filename
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                        {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                        {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}"

          - name: get-output-file-post-request-payload
            depends: compute-output-file-metadata.Succeeded
            templateRef:
              name: analysis-file-post-request-payload-v1-submittable
              template: analysis-file-post-request-payload
            arguments:
              parameters:
                - name: s3-key
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.out_s3_prefix')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}\
                          .tgz"
                - name: basename
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}"
                - name: file-size
                  value: "{{tasks.compute-output-file-metadata.outputs.parameters.file-size}}"
                - name: md5sum
                  value: "{{tasks.compute-output-file-metadata.outputs.parameters.md5sum}}"
                # TODO: these analysis files should be associated to an epigenome instead of experiment
                - name: experiment-id
                  value: "does-not-exist"
                - name: assembly-id
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.assembly_id')}}"
                - name: analysis-type
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.analysis_type')}}"

          - name: compress-file
            depends: compute-output-file-metadata.Succeeded
            templateRef:
              name: compress-tgz-pvc-callable-v1-submittable
              template: compress-tgz-pvc-callable-pigz
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"
                - name: filename
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}"
                - name: out-filename
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}\
                          .tgz"

          - name: save-file-to-s3
            depends: compress-file.Succeeded
            templateRef:
              name: from-pvc-to-s3-object-v1-submittable
              template: from-pvc-to-s3-object
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"
                - name: filename
                  value: "{{tasks.compress-file.outputs.parameters.out-filename}}"
                - name: s3-key
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.out_s3_prefix')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}\
                          .tgz"
                - name: cpu-limit
                  value: "6000m"
                - name: memory-limit
                  value: "20Gi"


    - name: dag-bed-output-files-post-processing
      parallelism: 1
      inputs:
        parameters:
          - name: task-payload
          - name: analysis-type-info
      dag:
        tasks:
          - name: compute-output-file-metadata
            templateRef:
              name: compute-file-metadata-v1-submittable
              template: compute-file-metadata
            arguments:
              parameters:
                - name: s3-key
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.out_s3_prefix')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}"
                - name: filename
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                        {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                        {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}"

          - name: get-output-file-post-request-payload
            depends: compute-output-file-metadata.Succeeded
            templateRef:
              name: analysis-file-post-request-payload-v1-submittable
              template: analysis-file-post-request-payload
            arguments:
              parameters:
                - name: s3-key
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.out_s3_prefix')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}\
                          {{=jsonpath(inputs.parameters['analysis-type-info'], '$.suffix')}}"
                - name: basename
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.prefix')}}\
                          {{=jsonpath(inputs.parameters['task-payload'], '$.out_basename')}}"
                - name: file-size
                  value: "{{tasks.compute-output-file-metadata.outputs.parameters.file-size}}"
                - name: md5sum
                  value: "{{tasks.compute-output-file-metadata.outputs.parameters.md5sum}}"
                # TODO: these analysis files should be associated to an epigenome instead of experiment
                - name: experiment-id
                  value: "does-not-exist"
                - name: assembly-id
                  value: "{{=jsonpath(inputs.parameters['task-payload'], '$.assembly_id')}}"
                - name: analysis-type
                  value: "{{=jsonpath(inputs.parameters['analysis-type-info'], '$.analysis_type')}}"



    - name: genrich-controls
      retryStrategy:
        limit: "3"
        retryPolicy: "OnError"
      inputs:
        parameters:
          - name: out_bed_filename
          - name: out_pq_values_filename
          - name: out_pileups_filename
          - name: out_s3_prefix
          - name: chipmentation
          - name: alignments-pvc
          - name: pq-values-pvc
          - name: pileups-pvc
      container:
        workingDir: /mnt/vol
        image: ghcr.io/daugo/ensembl-reg-genrich:latest
        command: [ bash, -c, -ue, -o, xtrace ]
        args: [ "ls -altrh \
                && SIGNAL_BAM_FILES=$(ls -m *.bam | xargs echo | sed 's/ //g') \
                && GENRICH_ARGS_1st_RUN=(
                  -t ${SIGNAL_BAM_FILES}
                  -X \
                  -f /mnt/vol_pq_values/{{inputs.parameters.out_pq_values_filename}} \
                  -k /mnt/vol_pileups/{{inputs.parameters.out_pileups_filename}} \
                  -r
                  -q 0.1
                  -s 20
                  -e MT
                  -v
                ) \
                && if [[ {{inputs.parameters.chipmentation}} == 'true' ]]; then GENRICH_ARGS_1st_RUN+=(-j); fi \
                && Genrich ${GENRICH_ARGS_1st_RUN[@]} \
                && ls -altrh \
                && GENRICH_ARGS_2nd_RUN=(
                  -P
                  -o {{inputs.parameters.out_bed_filename}}
                  -f /mnt/vol_pq_values/{{inputs.parameters.out_pq_values_filename}} \
                  -p 0.1
                  -v
                ) \
                && Genrich ${GENRICH_ARGS_2nd_RUN[@]} \
                && echo aw-artifacts/\
                {{workflow.creationTimestamp.Y}}/\
                {{workflow.creationTimestamp.m}}/\
                {{workflow.creationTimestamp.d}}/\
                {{workflow.name}}/{{pod.name}}/\
                main.log \
                > genrich-run-logs-s3-key.txt \
                && ls -altrh" ]
        resources:
          limits:
            cpu: 4900m
            memory: 58Gi
          requests:
            cpu: 4700m
            memory: 52Gi
        volumeMounts:
          - name: workdir
            mountPath: /mnt/vol
          - name: pq-values-vol
            mountPath: /mnt/vol_pq_values
          - name: pileups-vol
            mountPath: /mnt/vol_pileups
      volumes:
        - name: workdir
          persistentVolumeClaim:
            claimName: "{{inputs.parameters.alignments-pvc}}"
        - name: pq-values-vol
          persistentVolumeClaim:
            claimName: "{{inputs.parameters.pq-values-pvc}}"
        - name: pileups-vol
          persistentVolumeClaim:
            claimName: "{{inputs.parameters.pileups-pvc}}"
      outputs:
        parameters:
          - name: genrich-run-logs-s3-key
            valueFrom:
              path: /mnt/vol/genrich-run-logs-s3-key.txt
        artifacts:
          - name: final_bed
            path: /mnt/vol/{{inputs.parameters.out_bed_filename}}
            archive:
              none: { }
            s3:
              key: "{{inputs.parameters.out_s3_prefix}}{{inputs.parameters.out_bed_filename}}"
