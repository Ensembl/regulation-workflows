apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: bed-to-bigbed-pvc-callable-v1-submittable
  annotations:
    workflows.argoproj.io/description: |
      Generate bigbed file from peak bed file
spec:
  entrypoint: bed-to-bigbed-pvc-callable
  
  imagePullSecrets:
    - name: ghcr-pull-token
  
  podGC:
    strategy: OnPodSuccess

  templates:
    - name: bed-to-bigbed-pvc-callable
      inputs:
        parameters:
          - name: experiment-id
          - name: assembly-id
          - name: pvc-name
          - name: bed-filename
          - name: chrom-sizes-s3-key
          - name: bigbed-s3-key
          - name: bed-type
      dag:
        tasks:
          - name: sort-bed
            template: sort-bed-cmd
            arguments:
              parameters:
                - name: bed-filename
                  value: "{{inputs.parameters.bed-filename}}"
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"
        
          - name: convert-bed-to-bigbed
            depends: >-
              sort-bed.Succeeded
            template: convert-bed-to-bigbed-cmd
            arguments:
              parameters:
                - name: bed-filename
                  value: "{{inputs.parameters.bed-filename}}"
                - name: bigbed-s3-key
                  value: "{{inputs.parameters.bigbed-s3-key}}"
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"
                - name: chrom-sizes-s3-key
                  value: "{{inputs.parameters.chrom-sizes-s3-key}}"
                - name: bed-type
                  value: "{{inputs.parameters.bed-type}}"

          - name: remove-intermediate-sorted-bed-file-from-pvc
            depends: >- 
              convert-bed-to-bigbed.Succeeded
            templateRef:
              name: delete-file-from-pvc-v1-submittable
              template: delete-file-from-pvc
            arguments:
              parameters:
                - name: file-path
                  value: "{{=sprig.trimSuffix(sprig.ext(inputs.parameters['bed-filename']), sprig.base(inputs.parameters['bed-filename']))}}.sorted.bed"
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"

          - name: execute-compute-bigbed-file-metadata
            depends: >- 
              convert-bed-to-bigbed.Succeeded
            templateRef:
              name: compute-file-metadata-pvc-callable-v1-submittable
              template: compute-file-metadata-pvc-callable
            arguments:
              parameters:
                - name: pvc-name
                  value: "{{inputs.parameters.pvc-name}}"
                - name: filename
                  value: "{{=sprig.base(inputs.parameters['bigbed-s3-key'])}}"

          - name: execute-post-bigbed-file
            depends: execute-compute-bigbed-file-metadata
            templateRef:
              name: analysis-file-post-request-payload-v1-submittable
              template: analysis-file-post-request-payload
            arguments:
              parameters:
                - name: s3-key
                  value: "{{inputs.parameters.bigbed-s3-key}}"
                - name: basename
                  value: "{{=sprig.trimSuffix(sprig.ext(inputs.parameters['bigbed-s3-key']), sprig.base(inputs.parameters['bigbed-s3-key']))}}"
                - name: file-size
                  value: "{{tasks.execute-compute-bigbed-file-metadata.outputs.parameters.file-size}}"
                - name: md5sum
                  value: "{{tasks.execute-compute-bigbed-file-metadata.outputs.parameters.md5sum}}"
                - name: experiment-id
                  value: "{{inputs.parameters.experiment-id}}"
                - name: assembly-id
                  value: "{{inputs.parameters.assembly-id}}"
                - name: analysis-type
                  value: "peaks"

    - name: sort-bed-cmd
      retryStrategy:
        limit: "5"
        retryPolicy: "OnError"
      inputs:
        parameters:
          - name: bed-filename
          - name: pvc-name
      volumes:
        - name: workdir
          persistentVolumeClaim:
            claimName: '{{inputs.parameters.pvc-name}}'
      container:
        workingDir: /mnt/vol
        image: ghcr.io/daugo/ensembl-reg-bedsort:latest
        command: [ bash, -c, -ue, -o, xtrace ]
        args: [
          "ls -altrh \
          && bedSort {{inputs.parameters.bed-filename}}.bed {{inputs.parameters.bed-filename}}.sorted.bed \
          && ls -altrh"
        ]
        volumeMounts:
          - name: workdir
            mountPath: /mnt/vol
        resources:
          limits:
            cpu: 2900m
            memory: 10Gi
          requests:
            cpu: 2500m
            memory: 5Gi
    
    - name: convert-bed-to-bigbed-cmd
      retryStrategy:
        limit: "5"
        retryPolicy: "OnError"
      inputs:
        parameters:
          - name: bed-filename
          - name: bigbed-s3-key
          - name: pvc-name
          - name: chrom-sizes-s3-key
          - name: bed-type

        artifacts:
          - name: chrom_sizes_file
            path: /mnt/vol/chrom.sizes
            s3:
              key: "{{inputs.parameters.chrom-sizes-s3-key}}"
      volumes:
        - name: workdir
          persistentVolumeClaim:
            claimName: '{{inputs.parameters.pvc-name}}'
      container:
        imagePullPolicy: Always
        workingDir: /mnt/vol
        image: ghcr.io/daugo/ensembl-reg-bed-to-bigbed:latest
        command: [ bash, -c, -ue, -o, xtrace ]
        args: [
          "ls -altrh \
          && rm -f {{=sprig.base(inputs.parameters['bigbed-s3-key'])}} \
          && if [[ {{inputs.parameters.bed-type}} == 'narrow' ]]; \
          then bedToBigBed -as=/workdir/bigNarrowPeak.as -type=bed6+4 {{inputs.parameters.bed-filename}}.sorted.bed chrom.sizes {{=sprig.base(inputs.parameters['bigbed-s3-key'])}}; \
          elif [[ {{inputs.parameters.bed-type}} == 'gapped' ]]; \
          then bedToBigBed -tab -type=bed12+3 {{inputs.parameters.bed-filename}}.sorted.bed chrom.sizes {{=sprig.base(inputs.parameters['bigbed-s3-key'])}}; fi \
          && ls -altrh"
        ]
        volumeMounts:
          - name: workdir
            mountPath: /mnt/vol
        resources:
          limits:
            cpu: 2900m
            memory: 10Gi
          requests:
            cpu: 2500m
            memory: 5Gi
      outputs:
        artifacts:
          - name: final_bigbed
            path: "/mnt/vol/{{=sprig.base(inputs.parameters['bigbed-s3-key'])}}"
            archive:
              none: { }
            s3:
              key: "{{inputs.parameters.bigbed-s3-key}}"
 
